@inherits DotNetNuke.Web.Razor.DotNetNukeWebPage<dynamic>
@using System.Collections.Generic
@using System.Text.Json
@using System.Text.RegularExpressions
@using DotNetNuke.Web.DDRMenu
@using ToSic.Razor.Blade
@using Accuraty.Libraries.AccuLadder
@* 
WIP - non-Hover Primary default menu for AccuTheme

1. the remote live page is: all pages
2. the reference mockup by BEM is here (not much survived 20251005 JRF)
https://play.tailwindcss.com/O6RDUQWcAG
3. discussion about accessibility
https://www.tiny.cloud/blog/add-accordion-component/ 
4. ACCU4 Disclosure Examples
https://accu2025.accuraty.us/Tw4/Tw4-Disclosure-Discoveries-and-Examples
5. Nested Disclosures in the wild
https://tailwindflex.com/@emrys11/nested-dropdown << pattern used in NavSite

DDR provides us a tree of nested nodes, we recursively emit the menu 
using this conceptual tree of nested components WIP:
DDRMenu (root)
|- MenuHeader (usually just the wrapper)
|- MenuItemList (Level 0 default horizontal)
|  |- MenuItem (no children)
|     |- MenuIcon (optional)
|     |- MenuTitle
|     |- MenuLink
|  |- MenuDropdown (has children)
|     |- MenuItem (usually? Page Link Disabled)
|     |- SvgMenuStateIcon (chevron)
|     |- MenuItemList
|     |  |- MenuItems and/or MenuDropdowns
|- MenuFooter (usually just the /wrapper)

202504
NavSITE MENU is being rewritten to use Tailwind CSS from scratch
using the HTML Disclosure elements for a no JS solution.

- got it working in Tw Play (latest link is above) 20250417 BEM
- partially implemented below (svgTemplate, depth and hasChildren changes, etc) 20250417 BEM
- refactor to handle depth 0 vs 1+ changes with groups and more 20250508+ JRF
- rethink with new approach to allow Tw styling of the HTML using multi-line @strings... 20251001-05 JRF
*@
@{ 
  // TODO make sure this is false in production 
  const bool IsDebug = false;
  Accu.Dev.Debug = IsDebug;

  // Note that these strings are declared inside @functions{} and assigned here for easy Tailwind customization
  @*
  MenuHeader = @"
    <div class=""lg:flex text-xl gap-x-2 p-3 font-nav z-1 max-w-[80svw]"">
  ";
  MenuFooter = @"  
    </div>
  ";
  *@
  MenuHeader = @"
    <div class=""group z-30 focus-within:z-50 lg:static"">
      <button type=""button"" class=""inline-flex items-center justify-center rounded-md p-2 text-gray-700 hover:bg-gray-100 focus:ring-2 focus:ring-blue-500 
      focus:outline-none lg:hidden"" aria-label=""Open menu"">
        <svg class=""h-6 w-6"" fill=""none"" stroke=""currentColor"" viewBox=""0 0 24 24"">
          <path stroke-linecap=""round"" stroke-linejoin=""round"" stroke-width=""2"" d=""M4 6h16M4 12h16M4 18h16"" />
        </svg>
      </button>
      <div class=""absolute top-full left-[1rem] hidden w-[90svw] bg-white shadow-md rounded-lg group-focus-within:block lg:static lg:block lg:w-auto lg:shadow-none"">

        <div class=""flex list-none flex-col lg:align-middle lg:items-center lg:flex-row lg:*:ml-10 lg:[*]:data-search:ml-10 lg:*:data-search:border-l lg:*:data-search:border-gray-300 lg:*:data-search:pl-10 lg:*:data-search:bg-none lg:[&>a]:data-auth:ml-6 lg:*:data-search:ml-12 lg:*:data-auth:text-white lg:*:data-auth:bg-blue-600 lg:*:data-auth:hover:bg-blue-400 lg:*:data-auth:px-3 lg:*:data-auth:py-2 lg:*:data-auth:rounded-md lg:*:data-auth:shadow-sm"">
  ";
  MenuFooter = @"
        </div>
      </div>
    </div>
  "; 

  MenuItem = @"
    {0}
  ";

  // {0} Text or Link (Menu Name wrapped in HTML)
  // {1} Render Children (nested/recursive)
  // {2} Depth (Level)
  // {3} SvgMenuStateIcon
  // {4} MenuDropPosition[LEVEL]
  // {5} Data Attributes
  // {6} Debug (title/tooltip)
  //  >> possible data-attributes: 
  // data-menu-open-right, data-menu-open-left
  // data-active data-item-first data-item-last
  // {?} Icon [future]
  MenuDropdown = @"
    <details name=""level-{2}"" {5} class=""
      rounded-lg h-14
      hover:bg-zinc-100 
      open:bg-zinc-100 
      open:[&>summary_svg]:rotate-180 data-menu-right:[&>summary_svg]:rotate-270 data-menu-right:open:[&>summary_svg]:rotate-0 
      {4}
    "">
      <summary type=""button"" aria-expanded=""false"" data-level{2} class=""
        flex justify-between items-center gap-1 p-2 cursor-pointer font-semibold 
      "">
        {0}
        {3}
      </summary>
      <div class=""absolute min-w-64 bg-white p-2 rounded-xl shadow-lg ring-1 ring-zinc-900/5 z-10"">
        {1}
      </div>
    </details>
  ";

  // highlight colors for when this node is the current page or location (decendent of)
  // see MakeAriaCurrent() below for details
  // tried to make a RegEx that would match this in Tailwind IntelliSense, not working (see .vscode/settings.json) 20251130 JRF
  MenuHighlight_ItemBreadcrumbLocation_Class = "text-blue-dark";
  MenuHighlight_ItemSelectedPage_Class = "text-blue-dark bg-zinc-100";

  // Note: to drop centered on parent add "details-content:left-[50%] details-content:translate-x-[50%]" after top...
  // Level/Depth = 0; drop left-aligned, below
  MenuDropPosition[0] = @"
    details-content:xtop-full xopen:xdetails-content:z-1
  ";
  // Level/Depth = 1; open bottom align, below with offset
  MenuDropPosition[1] = @"
    open:details-content:m-3 open:details-content:shadow-md xopen:xdetails-content:z-2
  ";
  // FUTURE
  // Level/Depth = 2; open top-aligned, right
  MenuDropPosition[2] = @"
    details-content:left-full details-content:top-0 open:details-content:pl-2 xopen:xdetails-content:z-3
  ";
  // Level/Depth = 2; re-use from Level 1
  MenuDropPosition[2] = MenuDropPosition[1];

  MenuHeader = MenuHeader.Trim();
  MenuItem = MenuItem.TrimEnd();
  MenuDropdown = MenuDropdown.TrimEnd();
  MenuDropPosition[0] = MenuDropPosition[0].Trim();
  MenuDropPosition[1] = MenuDropPosition[1].Trim();
  MenuDropPosition[2] = MenuDropPosition[2].Trim();
  MenuFooter = MenuFooter.Trim();

  // this is re-using the SVG defined/output (below @functions {...}), see
  // https://developer.mozilla.org/en-US/docs/Web/SVG/Reference/Element/use
  MenuDropdownIcon = "<svg class=\"size-8\"><use href=\"#chevron-dropdown\"></use></svg>";
}

@*
  Output our SVG Dropdown Icon for (re)use.
  ****************************************************************************@
<!-- AccuTheme-Tw4/menus/NavPrimary/PrimaryMenu.cshtml - START -->
@*
  Init and trigger the magic.
  ****************************************************************************@
@RenderNav(Model.Source.root.Children, MenuHeader, MenuFooter)
<!-- AccuTheme-Tw4/menus/NavPrimary/PrimaryMenu.cshtml - END -->
    
@if (Accu.Dev.Debug)
{
  var OptionsTyped = ParseLooseJson(Model.Options);
    <div class="absolute top-32 left-0 bg-blue z-10 min-w-2xs">
      <details>
        <summary><h6 class="inline text-white">Debug Output Available...</h6></summary>
  <pre><code>Client Options are available as a JSON string to parse
  Model.Options:  @Model.Options
  OptionsTyped.AccuType:   @OptionsTyped.AccuType
  OptionsTyped.MinHeight:  @OptionsTyped.MinHeight
  OptionsTyped.UseShadows: @OptionsTyped.UseShadows
  OptionsTyped.MenuStyle:  @OptionsTyped.MenuStyle
  Model.Source is          @Model.Source.GetType()

  Template Arguments add items to the passed in Model, see menudef.xml and this will make sense
  Model.AddWrapperClass: @Model.AddWrapperClass

  There are also Types for these in DDRMenu.TemplateEngine, e.g. .ClientString, .TemplateArgument
  </code></pre>
          @Accu.Dev.GetLog(true)
      </details>
    </div>

}

@functions
{
  // set above in @{}
  private string MenuDropdown;
  private string[] MenuDropPosition = new string[3]; // TODO maybe convert to ArrayList and use .Add()?
  private string MenuItem;
  private string MenuHeader;
  private string MenuFooter;
  private string MenuDropdownIcon;
  private string MenuHighlight_ItemBreadcrumbLocation_Class;
  private string MenuHighlight_ItemSelectedPage_Class;

  public HtmlString RenderNav(IEnumerable<MenuNode> pages, string header = "", string footer = "")
  {
    // TODO figure out how to get the MenuStyle from DDRMenu
    System.Text.StringBuilder output = new System.Text.StringBuilder();
    System.Text.StringBuilder dataAttributes = new System.Text.StringBuilder();
    if (Text.Has(header))
    {
      Accu.Dev.Log("for DDRMenu MenuStyle: NavPrimary");
      output.Append(MenuHeader);
    }
    int depth = pages?.FirstOrDefault()?.Depth ?? -1;
    if (depth > 0)
    {
      dataAttributes.Append("data-menu-right");
    }
    
    Accu.Dev.Log($"depth: {depth}, dataAttributes: {dataAttributes.ToString()}");
    foreach (var page in pages)
    {
      // IDEA switch to array[] of args?
      output.AppendFormat(page.HasChildren() ? MenuDropdown : MenuItem,
        MakeLinkOrText(page),                         // {0}
        RenderNav(page.Children).ToString(),          // {1}
        page.Depth,                                   // {2}
        MenuDropdownIcon,                             // {3}
        "", //                                        // {4}
        dataAttributes.ToString().Trim(),             // {5}
        Accu.Dev.Debug ? MakeDebugTooltip(page) : ""  // {6}
      );
    }
    
    // if (pages.HasChildren() ? pages.FirstOrDefault().Depth == 0 : false)
    // if (pages.FirstOrDefault()?.Depth == 0)
    if (Text.Has(footer))
    {
      output.Append(MenuFooter);
    }
    return new HtmlString(output.ToString());
  }

  // TODO rename things if it is common to call this (non-dropdown) a Leaf Item in nav menu lingo?
  /// <summary>
  /// Creates the visible portion of this menu node. Handles everything DNN/DDRMenu supports
  /// and all accessibility requirements. 
  /// </summary>
  /// <param name="page">MenuNode page</param>
  /// <returns>HTML output; formatted Text or Icon with optional link, icon, etc</returns>
  /// <remarks>
  /// 1) .Icon (small icon) outputs Icon + Text 
  /// 2) .LargeImage (large icon) outputs just LargeImage as the solo icon (no Text)
  /// 3) if .Icon and .LargeImage are both specified, only Small Icon is used
  /// </remarks>
  public string MakeLinkOrText(MenuNode page)
  {
    System.Text.StringBuilder dataAttributes = new System.Text.StringBuilder();
    string attrTitle = string.Empty;
    var classList = new List<string>();
    // TODO for consistency and maintainability, figure out the right way to move this back up to the MenuItem class definitions (line ~59)
    classList.Add("block rounded-lg p-2 lg:flex lg:items-center hover:bg-zinc-100");
    // passing classList as ref so we can add a highlight (color) if page or location
    string ariaCurrent = MakeAriaCurrent(page, ref classList);

    // TODO either convert href+page.Url to use DNN nav() utils or find some other way to do proper relative links
    // NOTE the above TODO does not state its problem, we need to get better at that
    string attrTarget = !string.IsNullOrEmpty(page.Target) ? ($"target=\"{page.Target}\"") : string.Empty;
    string attrClass = string.Join(" ", classList);
    // string attrHref = page.Enabled ? page.Url : "javascript:void(0);";
    // Authenication Page ID
    if (page.TabId == 37)
    {
      // Added the dataAttribute for the authentication page
      dataAttributes.Append("data-auth");
    }
    if (page.TabId == 23)
    {
      // swap to Icon output for Search Results page 
      string output = "<i class=\"fa-regular fa-magnifying-glass-arrow-right fa-xl\"></i>";
      output = $"<span class=\"flex items-center\">{output}</span>";
      dataAttributes.Append("data-menu-special-end");
      return $"<a href=\"{page.Url}\" {attrTarget} class=\"{attrClass}\" {ariaCurrent} {dataAttributes.ToString().Trim()}>{output}</a>";
    }

    // DONE add pass-in options for link classes and specifying an icon
    if (page.Enabled)
    {
      if (Text.Has(page.LargeImage))
      {
        return $"<a href=\"{page.Url}\" {attrTarget} class=\"{attrClass}\" title=\"{page.Text}\" {ariaCurrent}><img src=\"{page.LargeImage}\" class=\"w-8\"></a>";
      }
      if (Text.Has(page.Icon))
      {
        return $"<a href=\"{page.Url}\" {attrTarget} class=\"{attrClass}\" title=\"{page.Text}\" {ariaCurrent}><img src=\"{page.Icon}\" class=\"inline me-2 w-6\"> {page.Text}</a>";
      }
      return $"<a href=\"{page.Url}\" {attrTarget} class=\"{attrClass}\" {ariaCurrent} {dataAttributes.ToString().Trim()}>{page.Text}</a>";
    }
    // page is Link Disabled (page.Enabled == false or [TabInfo].DisableLink == true)
    // Better/Accessibility Implementation, see https://github.com/Accuraty/AccuTheme-Tw4/issues/40 
    if (Accu.Dev.Debug)
    {
      attrTitle += $"[ debug note - this page is Link Disabled (URL would have been: {page.Url}) ]";
    }
    if (Text.Has(page.LargeImage))
    {
      attrTitle += $" {page.Text}";
      return $@"
      <a class=""no-underline cursor-not-allowed pointer-events-none {attrClass}"" 
        role=""link"" tabindex=""-1"" aria-disabled=""true"" {ariaCurrent} 
        title=""{attrTitle}"">
        <img src=""{page.LargeImage}"" class=""w-8"" title=""{page.Text}"" alt=""{page.Text}"">
      </a>";
    }
    return $@"
    <a class=""no-underline cursor-not-allowed pointer-events-none {attrClass}"" 
      role=""link"" tabindex=""-1"" aria-disabled=""true"" {ariaCurrent} 
      title=""{attrTitle}""
    >
      {page.Text}
    </a>";
  }
  
  /// <summary>
  /// For aria, .Selected is "page". .Breadcrumb is "location", else "". 
  /// </summary>
  /// <param name="page">MenuNode page</param>
  /// <param name="classList">by ref List of string classList</param>
  /// <returns>HTML Attribute aria-current for page or location, otherwise an empty string</returns>
  public string MakeAriaCurrent(MenuNode page, ref List<string> classList)
  {
    if (page.Selected)
    {
      classList.Add(MenuHighlight_ItemSelectedPage_Class);
      return $"aria-current=\"page\"";
    }
    if (page.Breadcrumb)
    {
      classList.Add(MenuHighlight_ItemBreadcrumbLocation_Class);
      return $"aria-current=\"location\"";
    }
    return string.Empty;
  }

  /// <summary>
  /// 
  /// </summary>
  /// <param name="param"></param>
  /// <returns></returns>
  public string MakeDebugTooltip(MenuNode page)
  {
    return $@"title=""      TabId: {page.TabId}
      Text: {page.Text}
      Icon (Small Icon): {page.Icon}
      LargeImage (Large Icon): {page.LargeImage}
      HasChildren: {page.HasChildren()}
      Depth: {page.Depth}
      Enabled: {page.Enabled}
      Breadcrumb: {page.Breadcrumb}
      Selected: {page.Selected}
      Target: {page.Target}
      Url: {page.Url}
    """;
    // return $"title=\"TabId: {page.TabId}\n HasChildren: {page.HasChildren()}\n Depth: {page.Depth}\n Enabled: {page.Enabled}\n Breadcrumb: {page.Breadcrumb}\n Selected: {page.Selected}\n Target: {page.Target}\n Url: {page.Url}\n Text: {page.Text}\"";
  }

  // TODO find and replace this with a .NET or other library call
  // NOTE although, converting MenuStateIcon to Svg...() method made this UNUSED
  public int clamp(int v, int min, int max)
  {
    int temp = v < min ? min : v;
    return temp > max ? max : temp;
  }

  public class ClientOptionsTyped
  {
    public string? AccuType { get; set; }
    public int MinHeight { get; set; }
    public bool UseShadows { get; set; }
    public string? MenuStyle { get; set; }
  }

  public static ClientOptionsTyped ParseLooseJson(string input)
  {
    // Quote unquoted keys (accuType: â†’ "accuType":)
    string normalized = Regex.Replace(input, @"(\w+):", "\"$1\":").Replace("'", "\"");
    Accu.Dev.Log("input normalized", normalized);
    return JsonSerializer.Deserialize<ClientOptionsTyped>(normalized);
  }

}

<!-- AccuTheme-Tw4/menus/NavPrimary/PrimaryMenu.cshtml >> Assets, this is our re-used dropdown icon #chevron-dropdown -->
<svg class="hidden">
  <symbol id="chevron-dropdown" class="" fill="currentColor" stroke="" viewBox="0 0 20 20" aria-hidden="true" data-slot="icon" data-chevron="">
    <path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd"></path>
  </symbol>
</svg>
